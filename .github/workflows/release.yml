name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (eg. v1.2.3)'
        required: true
        default: ''

permissions:
  contents: write

jobs:
  build-and-release-windows:
    name: Build & Release Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须为0，否则无法获取完整的Tag历史来计算Changelog

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri
        run: npm run tauri build
        env:
          CI: true

      - name: Rename Artifacts
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          $version = $tag -replace "^v", ""
          
          # 1. 处理 Portable EXE
          $portableSrc = "src-tauri/target/release/image-toolbox.exe"
          $portableDst = "src-tauri/target/release/image-toolbox_portable.exe"
          if (Test-Path $portableSrc) {
            Move-Item $portableSrc $portableDst
          }

          # 2. 处理 MSI
          $msiDir = "src-tauri/target/release/bundle/msi"
          if (Test-Path $msiDir) {
             $msiSrc = Get-ChildItem "$msiDir\*.msi" | Select-Object -First 1
             if ($msiSrc) {
                $msiDst = Join-Path $msiDir "image-toolbox_${version}_x64-setup.msi"
                Move-Item $msiSrc.FullName $msiDst
             }
          }

          # 3. 处理 NSIS (Exe安装包)
          $nsisDir = "src-tauri/target/release/bundle/nsis"
          if (Test-Path $nsisDir) {
             $nsisSrc = Get-ChildItem "$nsisDir\*.exe" | Select-Object -First 1
             if ($nsisSrc) {
                $nsisDst = Join-Path $nsisDir "image-toolbox_${version}_x64-nsis-setup.exe"
                Move-Item $nsisSrc.FullName $nsisDst
             }
          }

      # 上传 Artifacts 到 Actions Summary (含 zip，但不影响 Release)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            src-tauri/target/release/image-toolbox_portable.exe
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 5

      - name: Handle Tag (Create & Push if missing)
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) { Write-Error "Tag input is required"; exit 1 }

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --tags
          if (git tag -l $tag) {
            Write-Host "Tag $tag already exists."
          } else {
            Write-Host "Creating tag $tag ..."
            git tag -a $tag -m "Release $tag"
            git push origin $tag
          }

      # [新增步骤] 准备 Release Note 内容
      - name: Generate Release Note Content
        shell: pwsh
        run: |
          $currentTag = "${{ github.event.inputs.tag }}"
          $notePath = ".github/release_note.md"
          $outFile = "release_body.md"
          
          # 1. 读取基础内容
          if (Test-Path $notePath) {
            $content = Get-Content $notePath -Raw -Encoding UTF8
          } else {
            $content = "Release $currentTag"
          }

          # 2. 计算上一个 Tag
          # 重新拉取以确保包含刚才创建的 tag
          git fetch --tags --force 
          # 获取按创建时间倒序排列的 Tag 列表
          $tags = git tag --sort=-creatordate
          if ($tags -is [string]) { $tags = @($tags) } # 确保是数组

          $prevTag = $null
          
          # 逻辑：因为上一步 Handle Tag 保证了当前 tag 存在并已 push
          # 所以列表中第 0 个应该是当前 tag，第 1 个是上一个 tag
          if ($tags.Count -gt 1) {
             # 简单校验第一个是否为当前tag，如果是，取第二个
             if ($tags[0] -eq $currentTag) {
                $prevTag = $tags[1]
             } else {
                # 如果排序有出入，尝试遍历寻找
                $idx = $tags.IndexOf($currentTag)
                if ($idx -ge 0 -and ($idx + 1) -lt $tags.Count) {
                    $prevTag = $tags[$idx+1]
                }
             }
          }

          # 3. 拼接 Changelog 链接
          if ($prevTag) {
            $repoUrl = "https://github.com/${{ github.repository }}"
            $compareLink = "$repoUrl/compare/$prevTag...$currentTag"
            $content += "`n`n**Full Changelog**: $compareLink"
            Write-Host "Generated comparison link: $compareLink"
          } else {
            Write-Warning "Could not find previous tag to generate changelog link."
          }

          # 4. 写入临时文件供 Release 步骤使用
          Set-Content -Path $outFile -Value $content -Encoding UTF8

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          # 修改：使用 body_path 读取上一步生成的文件
          body_path: release_body.md
          # 确保这里不包含 generate_release_notes: true，否则会覆盖或冲突
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/image-toolbox_portable.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
