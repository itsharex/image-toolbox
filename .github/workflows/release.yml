name: Release

on:
  # âœ… ä»…å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œä¸”å¿…é¡»è¾“å…¥ Tag
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (eg. v1.2.3)'
        required: true
        default: ''

# æƒé™é…ç½®ï¼šå…è®¸åˆ›å»º Release å’Œ Tag
permissions:
  contents: write

jobs:
  build-and-release-windows:
    name: Build & Release Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥è¿›è¡Œ Tag æ“ä½œ

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # âœ… ä¼˜åŒ– 1: ä½¿ç”¨å®˜æ–¹æ¨èçš„ Rust å·¥å…·é“¾
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # ğŸ”´ æš‚æ—¶ç¦ç”¨ Rust ç¼“å­˜ä»¥è¿›è¡Œé—®é¢˜æ’æŸ¥
      # - name: Rust Cache
      #   uses: Swatinem/rust-cache@v2
      #   with:
      #     workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # âœ… ä¼˜åŒ– 3: ç§»é™¤äº† WiX å®‰è£…æ­¥éª¤ï¼ˆwindows-latest é•œåƒå·²å†…ç½®ï¼ŒèŠ‚çœæ—¶é—´ï¼‰

      - name: Decode and install certificate
        shell: pwsh
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.WINDOWS_SIGNING_CERT }}")
          $pfx_path = Join-Path $env:RUNNER_TEMP "cert.pfx"
          [System.IO.File]::WriteAllBytes("$pfx_path", $pfx_cert_byte)
          echo "TAURI_SIGNING_PRIVATE_KEY=$pfx_path" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.WINDOWS_SIGNING_CERT_PASSWORD }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        env:
          # ä»…åœ¨æä¾›äº† secrets çš„æƒ…å†µä¸‹æ‰è¿è¡Œæ­¤æ­¥éª¤
          CI: ${{ secrets.WINDOWS_SIGNING_CERT != '' && secrets.WINDOWS_SIGNING_CERT_PASSWORD != '' }}

      - name: Build Tauri
        run: npm run tauri build
        env:
          CI: true

      # âœ… ä¼˜åŒ– 4: ç®€åŒ– Tag å¤„ç†é€»è¾‘
      - name: Handle Tag (Create & Push if missing)
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) { Write-Error "Tag input is required"; exit 1 }

          # é…ç½® Git æœºå™¨äººèº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥ Tag æ˜¯å¦å­˜åœ¨
          git fetch --tags
          if (git tag -l $tag) {
            Write-Host "Tag $tag already exists."
          } else {
            Write-Host "Creating tag $tag ..."
            git tag -a $tag -m "Release $tag"
            git push origin $tag
          }

      # âœ… ä¼˜åŒ– 5: ä½¿ç”¨ softprops/action-gh-release å‘å¸ƒ
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          generate_release_notes: true # è‡ªåŠ¨æ ¹æ®æäº¤è®°å½•ç”Ÿæˆè¯´æ˜ï¼Œæ›¿ä»£æ‰‹åŠ¨è¯»å–æ–‡ä»¶
          draft: false
          prerelease: false
          fail_on_unmatched_files: false # é¿å…æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶æŠ¥é”™
          files: |
            LICENSE
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msix/*.msix
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/*.exe
            # æ³¨æ„ï¼šdist/*.zip åªæœ‰åœ¨ä½ æ‰‹åŠ¨å‹ç¼©äº† dist æ–‡ä»¶å¤¹åæ‰ä¼šæœ‰ï¼Œ
            # é»˜è®¤ tauri build ä¸ä¼šç”Ÿæˆ zipï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥åˆ é™¤ä¸‹é¢è¿™è¡Œ
            # dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
