name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (eg. v1.2.3)'
        required: true
        default: ''

permissions:
  contents: write

jobs:
  build-and-release-windows:
    name: Build & Release Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri
        run: npm run tauri build
        env:
          CI: true

      # --- MSIX Packaging & Signing Steps Start (REPAIRED) ---
      - name: Package MSIX
        shell: pwsh
        run: |
          # ---------------------------------------------------------
          # 1. 动态查找 MakeAppx.exe (避免路径硬编码错误)
          # ---------------------------------------------------------
          $kitsRoot = "C:\Program Files (x86)\Windows Kits\10\bin"
          $latestSdk = Get-ChildItem -Path $kitsRoot | Where-Object { $_.Name -match "^10\." } | Sort-Object Name -Descending | Select-Object -First 1
          
          if (-not $latestSdk) { Write-Error "No Windows SDK found"; exit 1 }
          
          $makeAppx = "$($latestSdk.FullName)\x64\MakeAppx.exe"
          Write-Host "Using MakeAppx: $makeAppx"

          if (-not (Test-Path $makeAppx)) { Write-Error "MakeAppx not found at $makeAppx"; exit 1 }

          # ---------------------------------------------------------
          # 2. 准备目录结构
          # ---------------------------------------------------------
          $distDir = "msix-dist"
          $iconDir = "$distDir\icons"
          if (Test-Path $distDir) { Remove-Item $distDir -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $iconDir

          # 拷贝主程序
          Copy-Item "src-tauri/target/release/image-toolbox.exe" -Destination "$distDir\image-toolbox.exe"
          # 拷贝图标
          Copy-Item "src-tauri/icons\*" -Destination $iconDir
          
          # ---------------------------------------------------------
          # 3. 处理 AppxManifest.xml (关键修复：版本号格式)
          # ---------------------------------------------------------
          $manifestSrc = "src-tauri/AppxManifest.xml"
          $manifestDst = "$distDir\AppxManifest.xml"
          
          # 读取 Manifest 内容
          [xml]$xml = Get-Content $manifestSrc
          $originalVersion = $xml.Package.Identity.Version
          
          # 检查版本号格式，如果只有3段 (x.y.z)，补全为4段 (x.y.z.0)
          if ($originalVersion -match '^\d+\.\d+\.\d+$') {
              $newVersion = "$originalVersion.0"
              Write-Warning "Auto-fixing Manifest Version: $originalVersion -> $newVersion"
              $xml.Package.Identity.Version = $newVersion
          } else {
              Write-Host "Manifest Version is already: $originalVersion"
          }
          
          # 保存修改后的 Manifest 到临时目录
          $xml.Save($manifestDst)

          # ---------------------------------------------------------
          # 4. 执行打包
          # ---------------------------------------------------------
          $msixDir = "src-tauri/target/release/bundle/msix"
          $msixPath = "$msixDir\image-toolbox.msix"
          New-Item -ItemType Directory -Force -Path $msixDir
          
          Write-Host "Packing to $msixPath ..."
          & $makeAppx pack /d "$distDir" /p "$msixPath" /o
          
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Sign MSIX
        shell: pwsh
        env:
          CERTIFICATE_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          # ---------------------------------------------------------
          # 1. 动态查找 SignTool.exe (关键修复：避免路径不存在错误)
          # ---------------------------------------------------------
          $kitsRoot = "C:\Program Files (x86)\Windows Kits\10\bin"
          $latestSdk = Get-ChildItem -Path $kitsRoot | Where-Object { $_.Name -match "^10\." } | Sort-Object Name -Descending | Select-Object -First 1
          $signtool = "$($latestSdk.FullName)\x64\signtool.exe"
          
          Write-Host "Using SignTool: $signtool"
          if (-not (Test-Path $signtool)) { Write-Error "SignTool not found"; exit 1 }

          $msixPath = "src-tauri/target/release/bundle/msix/image-toolbox.msix"

          if ($env:CERTIFICATE_BASE64) {
            Write-Host "Signing with provided certificate secret..."
            $pfxPath = "cert.pfx"
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CERTIFICATE_BASE64))
            
            # 使用动态找到的 signtool
            & $signtool sign /f $pfxPath /p "$env:CERTIFICATE_PASSWORD" /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $msixPath
            Remove-Item $pfxPath
          } else {
            Write-Host "No certificate secret found. Generating self-signed certificate for testing..."
            
            # 注意：这里生成的自签名证书 Subject 是 "CN=u202f"
            # 请确保你的 src-tauri/AppxManifest.xml 里的 Publisher 也是 "CN=u202f"
            # 否则安装时会报错 "Publisher mismatch"
            
            $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=u202f" -KeyUsage DigitalSignature -FriendlyName "ImageToolbox Test Cert" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
            
            $pfxPath = "self-signed.pfx"
            $password = ConvertTo-SecureString -String "password" -Force -AsPlainText
            Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $password
            
            # 使用动态找到的 signtool
            & $signtool sign /f $pfxPath /p "password" /fd SHA256 $msixPath
            
            Write-Warning "Signed with Self-Signed Cert. Install cert to Trusted Root first."
          }
      # --- MSIX Packaging & Signing Steps End ---

      - name: Rename Artifacts
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          $version = $tag -replace "^v", ""
          
          # Rename Portable EXE
          $portableSrc = "src-tauri/target/release/image-toolbox.exe"
          $portableDst = "src-tauri/target/release/image-toolbox_portable.exe"
          if (Test-Path $portableSrc) {
            Move-Item $portableSrc $portableDst
          }

          # Rename MSI
          $msiDir = "src-tauri/target/release/bundle/msi"
          if (Test-Path $msiDir) {
             $msiSrc = Get-ChildItem "$msiDir\*.msi" | Select-Object -First 1
             if ($msiSrc) {
                $msiDst = "$msiDir\image-toolbox_${version}_x64-setup.msi"
                Move-Item $msiSrc.FullName $msiDst
             }
          }

      - name: Handle Tag (Create & Push if missing)
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) { Write-Error "Tag input is required"; exit 1 }

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --tags
          if (git tag -l $tag) {
            Write-Host "Tag $tag already exists."
          } else {
            Write-Host "Creating tag $tag ..."
            git tag -a $tag -m "Release $tag"
            git push origin $tag
          }

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          generate_release_notes: true
          files: |
            LICENSE
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msix/*.msix
            src-tauri/target/release/image-toolbox_portable.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
