name: Release

on:
  # ✅ 仅允许手动触发，且必须输入 Tag
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (eg. v1.2.3)'
        required: true
        default: ''

# 权限配置：允许创建 Release 和 Tag
permissions:
  contents: write

jobs:
  build-and-release-windows:
    name: Build & Release Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史以进行 Tag 操作

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # ✅ 优化 1: 使用官方推荐的 Rust 工具链
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # ✅ 优化 2: 使用智能缓存（替代手动 cache 步骤）
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # ✅ 优化 3: 移除了 WiX 安装步骤（windows-latest 镜像已内置，节省时间）

      - name: Build Tauri
        run: npm run tauri build
        env:
          CI: true

      # ✅ 优化 4: 简化 Tag 处理逻辑
      - name: Handle Tag (Create & Push if missing)
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) { Write-Error "Tag input is required"; exit 1 }

          # 配置 Git 机器人身份
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查 Tag 是否存在
          git fetch --tags
          if (git tag -l $tag) {
            Write-Host "Tag $tag already exists."
          } else {
            Write-Host "Creating tag $tag ..."
            git tag -a $tag -m "Release $tag"
            git push origin $tag
          }

      # ✅ 优化 5: 使用 softprops/action-gh-release 发布
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          generate_release_notes: true # 自动根据提交记录生成说明，替代手动读取文件
          draft: false
          prerelease: false
          fail_on_unmatched_files: false # 避免找不到文件时报错
          files: |
            LICENSE
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/*.exe
            # 注意：dist/*.zip 只有在你手动压缩了 dist 文件夹后才会有，
            # 默认 tauri build 不会生成 zip，如果不需要可以删除下面这行
            # dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
