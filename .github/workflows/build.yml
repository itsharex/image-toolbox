name: Build

on:
  workflow_dispatch:
  # 建议添加 push 事件，以便在开发时自动测试构建
  # push:
  #   branches: [ main ]

jobs:
  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 1. 替换废弃的 actions-rs，使用官方推荐的 rust-toolchain
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # 2. 使用专业的 Rust 缓存 Action (替代手动 cache 步骤)
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # 3. 移除了 choco install wixtoolset (windows-latest 已内置)

      - name: Build Tauri bundles
        run: npm run tauri build
        env:
          CI: true

      # 4. 仅用于调试，生产环境可移除
      - name: List Output Files (Debug)
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -File src-tauri/target/release/bundle | Select-Object FullName, Length

      # 5. 优化上传路径，只保留安装包
      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: |
            LICENSE
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error
